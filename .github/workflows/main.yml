name: Build iOS IPA

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: stable

    - name: Install Ruby and Fastlane
      run: |
        brew install ruby
        gem install fastlane

    - name: Flutter pub get
      run: flutter pub get

    - name: Build IPA using Fastlane
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
      run: |
        cd ios

        # 使用 fastlane 的 sigh 自动生成开发证书和 Provisioning Profile
        fastlane run sigh \
          app_identifier:"$(defaults read ../Runner/Info CFBundleIdentifier)" \
          username:"$APPLE_ID" \
          skip_certificate_verification:true \
          development:true

        # 编译 IPA
        fastlane build_ios_app \
          scheme:"Runner" \
          export_method:"development" \
          clean:true

    - name: Upload IPA artifact
      uses: actions/upload-artifact@v3
      with:
        name: runner-ipa
        path: ios/build/Runner.ipa
