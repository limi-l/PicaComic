name: Build_IOS

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    runs-on: macos-13

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      # ğŸ”¹ ä¿®æ”¹åçš„æ­¥éª¤ï¼šåœ¨å·²æœ‰ post_install é‡Œæ³¨å…¥é…ç½®
      - name: Patch Podfile (inject concurrency settings)
        run: |
          sed -i.bak '/post_install do |installer|/a \
            \  installer.pods_project.targets.each do |target| \
            \    target.build_configurations.each do |config| \
            \      config.build_settings["SWIFT_STRICT_CONCURRENCY"] = "complete" \
            \      config.build_settings["OTHER_SWIFT_FLAGS"] ||= [""] \
            \      config.build_settings["OTHER_SWIFT_FLAGS"] << "-Xfrontend" << "-disable-availability-checking" \
            \    end \
            \  end \
          ' ios/Podfile

      - name: Install CocoaPods
        run: |
          cd ios
          pod install --repo-update

      - name: Build iOS app
        run: flutter build ios --release --no-codesign
