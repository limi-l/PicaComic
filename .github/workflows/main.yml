name: Build iOS IPA

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4
      
    - uses: subosito/flutter-action@v2
      with:
        channel: stable
        
    - run: flutter clean && flutter pub get
        
    - run: |
        cd ios
        pod install
        
    - run: gem install fastlane
        
    - name: Get Bundle ID
      id: bundle_id
      run: |
        BUNDLE_ID=$(/usr/libexec/PlistBuddy -c "Print CFBundleIdentifier" ios/Runner/Info.plist)
        echo "bundle_identifier=$BUNDLE_ID" >> $GITHUB_OUTPUT
        
    - name: Build IPA
      env:
        APPLE_ID: ${{ secrets.APPLE_ID }}
        APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
      run: |
        cd ios
        fastlane sigh --app_identifier "${{ steps.bundle_id.outputs.bundle_identifier }}" --username "$APPLE_ID" --development --force
        fastlane gym --scheme "Runner" --export_method "development" --clean
          
    - uses: actions/upload-artifact@v4
      with:
        name: runner-ipa
        path: ios/build/Runner.ipa
